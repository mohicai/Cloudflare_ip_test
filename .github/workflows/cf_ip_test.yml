- name: Calculate summary with random samples and timing
    run: |
      success=$(wc -l < merged/unblocked.txt || echo 0)
      fail=$(wc -l < merged/blocked.txt || echo 0)
      total=$((success+fail))
      if [ "$total" -gt 0 ]; then
        rate=$(echo "scale=2; $success*100/$total" | bc)
      else
        rate=0
      fi

      totaltime=$(awk '{sum+=$2} END {print sum}' merged/job_times.txt)
      job_count=$(wc -l < merged/job_times.txt)
      if [ "$job_count" -gt 0 ]; then
        avg_time=$(echo "scale=2; $totaltime/$job_count" | bc)
      else
        avg_time=0
      fi

      echo "### Cloudflare IP Test Summary" >> $GITHUB_STEP_SUMMARY
      echo "- 成功: $success" >> $GITHUB_STEP_SUMMARY
      echo "- 失败: $fail" >> $GITHUB_STEP_SUMMARY
      echo "- 总数: $total" >> $GITHUB_STEP_SUMMARY
      echo "- 成功率: $rate%" >> $GITHUB_STEP_SUMMARY
      echo "- 总耗时: ${totaltime}s" >> $GITHUB_STEP_SUMMARY
      echo "- 平均每个 job 耗时: ${avg_time}s" >> $GITHUB_STEP_SUMMARY
      echo "- 总 job 数量: ${{ github.event.inputs.jobs }}" >> $GITHUB_STEP_SUMMARY
      echo "- 平均每个 job 测试 IP 数: ${{ needs.generate-matrix.outputs.per_job }}" >> $GITHUB_STEP_SUMMARY
      echo "- 参数 interval: ${{ github.event.inputs.interval }}" >> $GITHUB_STEP_SUMMARY

      echo "" >> $GITHUB_STEP_SUMMARY
      echo "#### 每个 job 耗时分布 (含限制值)" >> $GITHUB_STEP_SUMMARY
      awk '{printf "- 起始索引 %s: %ss (限制 %s 分钟)\n",$1,$2,$3}' merged/job_times.txt >> $GITHUB_STEP_SUMMARY

      if [ "$success" -gt 0 ]; then
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "#### 随机成功 IP 示例 (最多 10 个)" >> $GITHUB_STEP_SUMMARY
        shuf -n 10 merged/unblocked.txt >> $GITHUB_STEP_SUMMARY
      fi

      if [ "$fail" -gt 0 ]; then
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "#### 随机失败 IP 示例 (最多 10 个)" >> $GITHUB_STEP_SUMMARY
        shuf -n 10 merged/blocked.txt >> $GITHUB_STEP_SUMMARY

  - name: Upload merged results
    uses: actions/upload-artifact@v4
    with:
      name: merged-results
      path: merged