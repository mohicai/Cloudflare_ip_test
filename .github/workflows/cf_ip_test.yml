name: Cloudflare IP Test

on:
  workflow_dispatch:
    inputs:
      jobs:
        description: "总 job 数量 (输入数字)"
        required: true
        default: "50"
      interval:
        description: "进度条刷新间隔 (秒)"
        required: true
        default: "5"

jobs:
  generate-matrix:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      perjob: ${{ steps.set-matrix.outputs.perjob }}
    steps:
      - name: Fetch Cloudflare IPs
        id: fetch
        run: |
          curl -s https://www.cloudflare.com/ips-v4 > ips.txt
          # 展开所有 IP 到 all_ips.txt
          > all_ips.txt
          while read cidr; do
            python3 - <<'EOF' >> all_ips.txt
import ipaddress,sys
cidr=sys.stdin.read().strip()
net=ipaddress.ip_network(cidr)
for ip in net.hosts():
    print(ip)
EOF <<< "$cidr"
          done < ips.txt
          count=$(wc -l < all_ips.txt)
          echo "total=$count" >> $GITHUB_ENV

      - name: Generate matrix JSON
        id: set-matrix
        run: |
          total=${{ env.total }}
          jobs=${{ github.event.inputs.jobs }}
          # 确保 jobs 是数字
          jobs=$(($jobs))
          perjob=$(( (total + jobs - 1) / jobs ))
          arr="["
          for ((i=0; i<total; i+=perjob)); do
            arr="$arr\"$i\","
          done
          arr="${arr%,}]"
          echo "matrix=$arr" >> $GITHUB_OUTPUT
          echo "perjob=$perjob" >> $GITHUB_OUTPUT

      - name: Upload all_ips.txt
        uses: actions/upload-artifact@v4
        with:
          name: all-ips
          path: all_ips.txt

  test:
    needs: generate-matrix
    runs-on: ubuntu-latest
    timeout-minutes: 120
    strategy:
      matrix:
        batch: ${{ fromJSON(needs.generate-matrix.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      - run: pip install aiohttp tqdm
      - name: Download all_ips.txt
        uses: actions/download-artifact@v4
        with:
          name: all-ips
          path: .
      - name: Run IP test
        run: |
          start=$(date +%s)
          python3 testcfips.py \
            --start ${{ matrix.batch }} \
            --limit ${{ needs.generate-matrix.outputs.perjob }} \
            --interval ${{ github.event.inputs.interval }}
          end=$(date +%s)
          echo "${{ matrix.batch }} $((end-start)) 120" > job_time.txt
      - name: Upload partial results
        uses: actions/upload-artifact@v4
        with:
          name: results-${{ matrix.batch }}
          path: |
            blocked.txt
            unblocked.txt
            curl_errors.log
            job_time.txt

  merge-results:
    needs: test
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Merge results
        run: |
          mkdir -p merged
          # 合并所有结果文件
          for dir in artifacts/results-*/; do
            if [ -d "$dir" ]; then
              cat "$dir/blocked.txt" 2>/dev/null >> merged/blocked.txt || true
              cat "$dir/unblocked.txt" 2>/dev/null >> merged/unblocked.txt || true
              cat "$dir/curl_errors.log" 2>/dev/null >> merged/curl_errors.log || true
              cat "$dir/job_time.txt" 2>/dev/null >> merged/job_times.txt || true
            fi
          done

      - name: Calculate summary with random samples and timing
        run: |
          success=0
          fail=0
          totaltime=0
          jobcount=0
          
          if [ -f merged/unblocked.txt ]; then
            success=$(wc -l < merged/unblocked.txt)
          fi
          
          if [ -f merged/blocked.txt ]; then
            fail=$(wc -l < merged/blocked.txt)
          fi
          
          total=$((success + fail))
          
          if [ "$total" -gt 0 ]; then
            rate=$(echo "scale=2; $success * 100 / $total" | bc)
          else
            rate=0
          fi
          
          if [ -f merged/job_times.txt ]; then
            totaltime=$(awk '{sum+=$2} END {print sum}' merged/job_times.txt)
            jobcount=$(wc -l < merged/job_times.txt)
          fi
          
          if [ "$jobcount" -gt 0 ]; then
            avgtime=$(echo "scale=2; $totaltime / $jobcount" | bc)
          else
            avgtime=0
          fi
          
          echo "### Cloudflare IP Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "- 成功: $success" >> $GITHUB_STEP_SUMMARY
          echo "- 失败: $fail" >> $GITHUB_STEP_SUMMARY
          echo "- 总数: $total" >> $GITHUB_STEP_SUMMARY
          echo "- 成功率: $rate%" >> $GITHUB_STEP_SUMMARY
          echo "- 总耗时: ${totaltime}s" >> $GITHUB_STEP_SUMMARY
          echo "- 平均每个 job 耗时: ${avgtime}s" >> $GITHUB_STEP_SUMMARY
          echo "- 总 job 数量: ${{ github.event.inputs.jobs }}" >> $GITHUB_STEP_SUMMARY
          echo "- 平均每个 job 测试 IP 数: ${{ needs.generate-matrix.outputs.perjob }}" >> $GITHUB_STEP_SUMMARY
          echo "- 参数 interval: ${{ github.event.inputs.interval }}" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### 每个 job 耗时分布 (含限制值)" >> $GITHUB_STEP_SUMMARY
          
          if [ -f merged/job_times.txt ]; then
            awk '{printf "- 起始索引 %s: %ss (限制 %s 分钟)\n", $1, $2, $3}' merged/job_times.txt >> $GITHUB_STEP_SUMMARY
          else
            echo "无耗时数据" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$success" -gt 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "#### 随机成功 IP 示例 (最多 10 个)" >> $GITHUB_STEP_SUMMARY
            shuf -n 10 merged/unblocked.txt 2>/dev/null >> $GITHUB_STEP_SUMMARY || echo "无法获取成功 IP 示例" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$fail" -gt 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "#### 随机失败 IP 示例 (最多 10 个)" >> $GITHUB_STEP_SUMMARY
            shuf -n 10 merged/blocked.txt 2>/dev/null >> $GITHUB_STEP_SUMMARY || echo "无法获取失败 IP 示例" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload merged results
        uses: actions/upload-artifact@v4
        with:
          name: merged-results
          path: merged