name: Cloudflare IP Test

on:
  workflow_dispatch:
    inputs:
      jobs:
        description: "总 job 数量 (输入数字，最大 256)"
        required: true
        default: "20"
      interval:
        description: "进度条刷新间隔 (秒)"
        required: true
        default: "5"

jobs:
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.split.outputs.matrix }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      - run: pip install requests
      - name: Generate job assignments
        id: split
        run: |
          python split_cidrs.py --jobs ${{ github.event.inputs.jobs }} > assignments.json
          echo "matrix=$(cat assignments.json)" >> $GITHUB_OUTPUT
      - name: Upload assignments
        uses: actions/upload-artifact@v4
        with:
          name: cidr-assignments
          path: assignments.json
      - name: Upload job summary
        uses: actions/upload-artifact@v4
        with:
          name: job-summary
          path: job_summary.txt
      - name: Print job summary
        run: |
          echo "### CIDR 分配详情" >> $GITHUB_STEP_SUMMARY
          cat job_summary.txt >> $GITHUB_STEP_SUMMARY

  test:
    needs: generate-matrix
    runs-on: ubuntu-latest
    strategy:
      matrix:
        job: ${{ fromJSON(needs.generate-matrix.outputs.matrix) }}
      max-parallel: 10
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      - run: pip install tqdm aiohttp
      - name: Run IP test
        run: |
          for cidr in ${{ join(matrix.job, ' ') }}; do
            echo "$cidr" >> cidrs_part.txt
          done
          python test_cf_ips.py --cidr-file cidrs_part.txt --limit all --interval ${{ github.event.inputs.interval }}
      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: results-${{ matrix.job }}
          path: |
            blocked.txt
            unblocked.txt
            curl_errors.log

  merge-results:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Merge results
        run: |
          mkdir merged
          cat artifacts/**/blocked.txt > merged/blocked.txt || true
          cat artifacts/**/unblocked.txt > merged/unblocked.txt || true
          cat artifacts/**/curl_errors.log > merged/curl_errors.log || true

      - name: Summary
        run: |
          success=$(wc -l < merged/unblocked.txt || echo 0)
          fail=$(wc -l < merged/blocked.txt || echo 0)
          total=$((success+fail))
          if [ "$total" -gt 0 ]; then
            rate=$(echo "scale=2; $success*100/$total" | bc)
          else
            rate=0
          fi
          echo "### Cloudflare IP Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "- 成功: $success" >> $GITHUB_STEP_SUMMARY
          echo "- 失败: $fail" >> $GITHUB_STEP_SUMMARY
          echo "- 总数: $total" >> $GITHUB_STEP_SUMMARY
          echo "- 成功率: $rate%" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "$success" -gt 0 ]; then
            echo "#### 随机成功 IP 示例" >> $GITHUB_STEP_SUMMARY
            shuf -n 10 merged/unblocked.txt >> $GITHUB_STEP_SUMMARY
          fi
          if [ "$fail" -gt 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "#### 随机失败 IP 示例" >> $GITHUB_STEP_SUMMARY
            shuf -n 10 merged/blocked.txt >> $GITHUB_STEP_SUMMARY
          fi
          if [ -s merged/curl_errors.log ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "#### 随机错误日志样本" >> $GITHUB_STEP_SUMMARY
            shuf -n 5 merged/curl_errors.log >> $GITHUB_STEP_SUMMARY