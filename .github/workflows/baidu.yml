name: Baidu Cloudflare IP Test

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download Mihomo
        run: |
          curl -L https://github.com/MetaCubeX/mihomo/releases/latest/download/mihomo-linux-amd64 -o mihomo
          chmod +x mihomo

      - name: Create Mihomo config
        run: |
          cat > config.yaml <<'EOF'
          port: 7890
          socks-port: 7891
          allow-lan: true
          mode: Rule
          log-level: info

          proxies:
            - name: "北京电信"
              type: http
              server: 220.181.33.174
              port: 443
              headers:
                X-T5-Auth: "683556433"
                Host: "153.3.236.22:443"

          proxy-groups:
            - name: "自动选择"
              type: select
              proxies:
                - "北京电信"

          rules:
            - MATCH,自动选择
          EOF

      - name: Start Mihomo
        run: |
          nohup ./mihomo -f config.yaml > mihomo.log 2>&1 &
          sleep 5

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests tqdm

      - name: Run Cloudflare IP Test
        run: |
          python cf1.py --limit 500 --concurrency 50

      - name: Push results to repository
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add blocked.txt unblocked.txt
          git commit -m "Update Cloudflare IP test results [skip ci]" || echo "No changes to commit"
          git push