name: Cloudflare IP Test

on:
  workflow_dispatch:
    inputs:
      limit:
        description: "测试数量 (输入数字 或 all)"
        required: true
        default: "1000"
      interval:
        description: "进度条刷新间隔 (秒)"
        required: true
        default: "5"

jobs:
  generate-matrix:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Fetch Cloudflare IPs
        id: fetch
        run: |
          curl -s https://www.cloudflare.com/ips-v4 > ips.txt
          count=$(wc -l < ips.txt)
          echo "total=$count" >> $GITHUB_ENV

      - name: Generate matrix JSON
        id: set-matrix
        run: |
          total=${{ env.total }}
          step=2
          arr="["
          for ((i=0; i<total; i+=step)); do
            arr="$arr\"$i\","
          done
          arr="${arr%,}]"
          echo "matrix=$arr" >> $GITHUB_OUTPUT

  test:
    needs: generate-matrix
    runs-on: ubuntu-latest
    timeout-minutes: 120
    strategy:
      matrix:
        batch: ${{ fromJSON(needs.generate-matrix.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      - run: pip install aiohttp tqdm
      - name: Run IP test
        run: |
          start=$(date +%s)
          python test_cf_ips.py \
            --start ${{ matrix.batch }} \
            --count 2 \
            --interval ${{ github.event.inputs.interval }} \
            --limit ${{ github.event.inputs.limit }}
          end=$(date +%s)
          echo "${{ matrix.batch }} $((end-start)) 120" > job_time.txt
      - name: Upload partial results
        uses: actions/upload-artifact@v4
        with:
          name: results-${{ matrix.batch }}
          path: |
            blocked.txt
            unblocked.txt
            curl_errors.log
            job_time.txt

  merge-results:
    needs: test
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Merge results
        run: |
          mkdir merged
          cat artifacts/**/blocked.txt > merged/blocked.txt || true
          cat artifacts/**/unblocked.txt > merged/unblocked.txt || true
          cat artifacts/**/curl_errors.log > merged/curl_errors.log || true
          cat artifacts/**/job_time.txt > merged/job_times.txt || true

      - name: Calculate summary with random samples and timing
        run: |
          success=$(wc -l < merged/unblocked.txt || echo 0)
          fail=$(wc -l < merged/blocked.txt || echo 0)
          total=$((success+fail))
          if [ "$total" -gt 0 ]; then
            rate=$(echo "scale=2; $success*100/$total" | bc)
          else
            rate=0
          fi

          total_time=$(awk '{sum+=$2} END {print sum}' merged/job_times.txt)
          job_count=$(wc -l < merged/job_times.txt)
          if [ "$job_count" -gt 0 ]; then
            avg_time=$(echo "scale=2; $total_time/$job_count" | bc)
            eta_sec=$(echo "$avg_time*$job_count" | bc)
            eta=$(date -d "@$eta_sec" +%H:%M:%S)
          else
            avg_time=0
            eta="N/A"
          fi

          echo "### Cloudflare IP Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "- 成功: $success" >> $GITHUB_STEP_SUMMARY
          echo "- 失败: $fail" >> $GITHUB_STEP_SUMMARY
          echo "- 总数: $total" >> $GITHUB_STEP_SUMMARY
          echo "- 成功率: $rate%" >> $GITHUB_STEP_SUMMARY
          echo "- 总耗时: ${total_time}s" >> $GITHUB_STEP_SUMMARY
          echo "- 平均每个 job 耗时: ${avg_time}s" >> $GITHUB_STEP_SUMMARY
          echo "- 预计完成时间: $eta" >> $GITHUB_STEP_SUMMARY
          echo "- 参数 limit: ${{ github.event.inputs.limit }}" >> $GITHUB_STEP_SUMMARY
          echo "- 参数 interval: ${{ github.event.inputs